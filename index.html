<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MamaChef â€” Serious game for recipes, planning, and best practices</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#ff3860">
  
  <!-- ios support -->
  <link rel="apple-touch-icon" href="/images/icon-180x180.png">
  <link rel="apple-touch-icon" href="/images/icon-96x96.png">
  <meta name="apple-mobile-web-app-status-bar" content="#ff3860">
  <meta name="theme-color" content="#ff3860">    

  <!-- Bulma v1 (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css" />

  <!-- Vue 3 (CDN) -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <!-- Font Awesome (ICONS) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root {
      --brand: #ff3860;
    }
    html, body {
      overflow-x: hidden;
    }
    body {
      background: #fafafa;
    }
    .app-hero {
      background: linear-gradient(135deg, #ffdd57 0%, #ff3860 100%);
      color: #fff;
    }
    .navbar {
      border-bottom: 1px solid rgba(0,0,0,0.06);
      backdrop-filter: blur(6px);
    }
    h1.title {
        text-shadow: 1px 1px #2e333d;
    }
    .score-badge {
      background: #fff;
      border-radius: 999px;
      padding: 0.25rem 0.75rem;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      display: inline-flex;
      gap: 0.5rem;
      align-items: center;
      color: #363636;
    }
    .tag-halal {
      background: #22c55e !important;
      color: #fff !important;
    }
    .card .image img {
      object-fit: cover;
    }
    .pill {
      border-radius: 999px;
    }
    .is-clickable {
      cursor: pointer;
    }
    .fixed-footer {
      position: sticky;
      bottom: 0;
      z-index: 5;
      background: #fff;
      border-top: 1px solid rgba(0,0,0,0.06);
      padding-bottom: env(safe-area-inset-bottom);
    }
    .progress.is-thin {
      height: 6px;
    }
    .small {
      font-size: 0.9rem;
    }
    .smaller {
      font-size: 0.8rem;
    }
    .nowrap {
      white-space: nowrap;
    }
    .pointer {
      cursor: pointer;
    }
    .recipe-img {
      border-radius: 10px;
      overflow: hidden;
      background: #f6f6f6;
    }
    .kbd {
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-bottom-width: 3px;
      padding: 0 0.4rem;
      border-radius: 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.85em;
    }
    .overlay-hint {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.65);
      color: #fff;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      font-size: 0.75rem;
    }
    .card-footer-item.is-danger:hover {
      background: #fff5f7;
    }
    /* Mobile tweaks */
    @media (max-width: 768px) {
      .columns.is-mobile-compact {
        margin-left: 0;
        margin-right: 0;
      }
      .columns.is-mobile-compact > .column {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }
      /* Fixed footer actions: wrap controls and show icons only */
      .fixed-footer .field.has-addons { flex-wrap: wrap; }
      .fixed-footer .field.has-addons .control { flex: 1 1 auto; margin-bottom: 0.5rem; }
      .fixed-footer .field.has-addons .control.is-expanded { order: 4; flex-basis: 100%; }
      /* Compact tables */
      .table th, .table td { padding: 0.5rem 0.75rem; }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- NAVBAR -->
    <nav class="navbar is-white" role="navigation" aria-label="main navigation">
      <div class="container">
        <div class="navbar-brand">
          <a class="navbar-item" @click="view='home'; mobileNav=false">
            <span class="icon has-text-danger"><i class="fa-solid fa-utensils"></i></span>
            <strong class="ml-2">MamaChef</strong>
          </a>
          <a role="button"
             class="navbar-burger"
             :class="{'is-active': mobileNav}"
             aria-label="menu"
             :aria-expanded="mobileNav ? 'true' : 'false'"
             @click="mobileNav = !mobileNav">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
          </a>
        </div>

        <div class="navbar-menu" :class="{'is-active': mobileNav}">
          <div class="navbar-start">
            <a class="navbar-item" :class="{'has-text-danger': view==='home'}" @click="view='home'; mobileNav=false">
              Home
            </a>
            <a class="navbar-item" :class="{'has-text-danger': view==='recipes'}" @click="view='recipes'; mobileNav=false">
              Recipes
            </a>
            <a class="navbar-item" :class="{'has-text-danger': view==='planning'}" @click="view='planning'; mobileNav=false">
              Planning
            </a>
            <a class="navbar-item" :class="{'has-text-danger': view==='inventory'}" @click="view='inventory'; mobileNav=false">
              Ingredients
            </a>
            <a class="navbar-item" :class="{'has-text-danger': view==='tips'}" @click="view='tips'; mobileNav=false">
              Chef Tips
            </a>
            <a class="navbar-item" :class="{'has-text-danger': view==='profile'}" @click="view='profile'; mobileNav=false">
              Profile & Scores
            </a>
          </div>

          <div class="navbar-end">
            <div class="navbar-item">
              <div class="score-badge">
                <span class="icon has-text-warning"><i class="fa-solid fa-star"></i></span>
                <span>{{ totalScore }} pts</span>
                <span class="tag is-danger is-light pill is-small ml-2">Level {{ level }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- HERO -->
    <section class="hero app-hero">
      <div class="hero-body">
        <div class="container">
          <div class="columns is-vcentered">
            <div class="column">
              <h1 class="title is-3 mb-2">Healthy & Balanced Recipes</h1>
              <p class="subtitle has-text-dark">
                Create, review, and plan your meals. Earn points, level up, and unlock culinary challenges from around the world.
              </p>

              <div class="buttons">
                <button class="button is-dark" @click="view='recipes'">
                  <span class="icon"><i class="fa-solid fa-bowl-food"></i></span>
                  <span>Explore recipes</span>
                </button>
                <button class="button is-danger" @click="quickChallenge()">
                  <span class="icon"><i class="fa-solid fa-bolt"></i></span>
                  <span>Quick Challenge</span>
                </button>
                <button class="button is-light" @click="generateChefTip()">
                  <span class="icon"><i class="fa-solid fa-graduation-cap"></i></span>
                  <span>Chef's Tip</span>
                </button>
              </div>
            </div>
            <div class="column">
              <div class="box">
                <p class="title is-5 mb-2">Progress</p>
                <progress class="progress is-danger is-thin" :value="progressPercent" max="100">{{ progressPercent }}%</progress>
                <div class="columns is-variable is-1 mt-3">
                  <div class="column has-text-centered">
                    <p class="heading">Recipes</p>
                    <p class="title is-6">{{ recipes.length }}</p>
                  </div>
                  <div class="column has-text-centered">
                    <p class="heading">Planning</p>
                    <p class="title is-6">{{ plannedMealsCount }}</p>
                  </div>
                  <div class="column has-text-centered">
                    <p class="heading">Tips read</p>
                    <p class="title is-6">{{ tipsRead }}</p>
                  </div>
                  <div class="column has-text-centered">
                    <p class="heading">Challenges</p>
                    <p class="title is-6">{{ challengesDone }}</p>
                  </div>
                </div>
                <p class="small mt-2">
                  Next level target: {{ nextLevelTarget }} pts
                </p>
              </div>
            </div>
          </div>

          <div class="notification is-light mt-2 has-text-dark is-hidden-mobile">
            Tip: press <span class="kbd">R</span> to generate a recipe via AI, <span class="kbd">T</span> for a Chef's tip, <span class="kbd">D</span> for a challenge.
          </div>
        </div>
      </div>
    </section>

    <!-- MAIN CONTENT -->
    <section class="section pt-5">
      <div class="container">
        <!-- HOME -->
        <div v-show="view==='home'">
          <div class="columns is-multiline">
            <div class="column is-12">
              <article class="message is-info">
                <div class="message-header">
                  <p>Welcome to MamaChef</p>
                </div>
                <div class="message-body">
                  Use the AI generator to create new balanced halal recipes, manage your ingredients, and plan your weekly meals. The more you cook healthily and plan effectively, the more points you earn and the higher you level up!
                </div>
              </article>
            </div>
            <div class="column is-6">
              <div class="card">
                <header class="card-header">
                  <p class="card-header-title">
                    AI Recipe Generation
                  </p>
                </header>
                <div class="card-content">
                  <div class="content">
                    <label class="label">Prompt</label>
                    <div class="field has-addons">
                      <div class="control is-expanded">
                        <input class="input"
                               v-model="aiPrompt"
                               placeholder="E.g.: Algerian main course, chicken, vegetables, 600 kcal max, halal" />
                      </div>
                      <div class="control">
                        <button class="button is-danger" :class="{'is-loading': aiLoading}" @click="generateRecipe()">
                          Generate
                        </button>
                      </div>
                    </div>
                    <p class="help">The AI will propose a recipe, with calorie estimation and steps. Image generated automatically.</p>
                  </div>
                </div>
                <footer class="card-footer">
                  <a class="card-footer-item" @click="view='recipes'">View all recipes</a>
                </footer>
              </div>
            </div>

            <div class="column is-6">
              <div class="card">
                <header class="card-header">
                  <p class="card-header-title">Challenge of the day</p>
                </header>
                <div class="card-content">
                  <div class="content">
                    <p><strong>{{ dailyChallenge.title }}</strong></p>
                    <p class="small">{{ dailyChallenge.desc }}</p>
                    <div class="tags mt-2">
                      <span class="tag is-warning is-light">+{{ dailyChallenge.points }} pts</span>
                      <span class="tag tag-halal">Halal</span>
                      <span class="tag is-success is-light">Healthy</span>
                    </div>
                  </div>
                </div>
                <footer class="card-footer">
                  <a class="card-footer-item" @click="completeDailyChallenge()">Validate</a>
                  <a class="card-footer-item" @click="quickChallenge()">New challenge</a>
                </footer>
              </div>
            </div>
          </div>
        </div>

        <!-- RECIPES -->
        <div v-show="view==='recipes'">
          <div class="level">
            <div class="level-left">
              <div class="level-item">
                <p class="title is-5 has-text-dark">Recipes</p>
              </div>
            </div>
            
            <div class="level-right">
              <div class="level-item">
                <div class="field has-addons">
                  <p class="control is-expanded">
                    <input class="input" v-model="searchRecipe" placeholder="Search for a recipe..." />
                  </p>
                  <p class="control">
                    <span class="select">
                      <select v-model="filterTag">
                        <option value="">All</option>
                        <option>Starter</option>
                        <option>Main</option>
                        <option>Dessert</option>
                        <option>Snack</option>
                      </select>
                    </span>
                  </p>
                  <p class="control">
                    <button class="button is-danger" @click="generateRecipe()" :class="{'is-loading': aiLoading}">
                      <span class="icon"><i class="fa-solid fa-wand-magic-sparkles"></i></span>
                      <span class="is-hidden-mobile">New AI Recipe</span>
                    </button>
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="columns is-multiline is-mobile-compact">
            <div class="column is-12" v-if="filteredRecipes.length===0">
              <div class="notification is-light">No recipes for now. Try generating one using AI.</div>
            </div>
            <div v-for="r in filteredRecipes" :key="r.id" class="column is-12-tablet is-6-desktop">
              <div class="card">
                <div class="card-image" v-if="r.imageUrl">
                  <figure class="image is-16by9 recipe-img">
                    <img :src="r.imageUrl" :alt="r.title" />
                    <span class="overlay-hint">{{ r.calories || '?' }} kcal</span>
                  </figure>
                </div>
                <header class="card-header">
                  <p class="card-header-title">
                    {{ r.title }}
                  </p>
                </header>
                <div class="card-content">
                  <div class="content">
                    <div class="tags">
                      <span class="tag tag-halal">Halal</span>
                      <span class="tag is-link is-light" v-for="t in r.tags" :key="t">{{ t }}</span>
                    </div>

                    <p class="small"><strong>Ingredients:</strong> {{ r.ingredients.join(', ') }}</p>

                    <details class="mt-2">
                      <summary class="pointer">Steps</summary>
                      <ol class="mt-2">
                        <li v-for="(s,idx) in r.steps" :key="idx">{{ s }}</li>
                      </ol>
                    </details>

                    <div class="columns is-mobile mt-3">
                      <div class="column">
                        <span class="icon-text">
                          <span class="icon has-text-danger"><i class="fa-solid fa-fire"></i></span>
                          <span class="smaller">{{ r.calories || '?' }} kcal</span>
                        </span>
                      </div>
                      <div class="column has-text-right">
                        <button class="button is-small is-light" @click="addToPlan(r)">
                          <span class="icon"><i class="fa-solid fa-calendar-plus"></i></span>
                          <span>Plan</span>
                        </button>
                        <button class="button is-small is-light ml-1" @click="cookRecipe(r)">
                          <span class="icon has-text-success"><i class="fa-solid fa-check"></i></span>
                          <span>Cooked</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <footer class="card-footer">
                  <a class="card-footer-item" @click="editRecipe(r)">Edit</a>
                  <a class="card-footer-item is-danger" @click="deleteRecipe(r)">Delete</a>
                </footer>
              </div>
            </div>
          </div>
        </div>

        <!-- PLANNING -->
        <div v-show="view==='planning'">
          <div class="level">
            <div class="level-left">
              <div class="level-item">
                <p class="title is-5 has-text-dark">Meal planning (7 days)</p>
              </div>
            </div>
            <div class="level-right">
              <div class="level-item">
                <button class="button is-light" @click="autoPlan()">
                  <span class="icon"><i class="fa-solid fa-shuffle"></i></span>
                  <span>Auto-plan</span>
                </button>
              </div>
            </div>
          </div>

          <div class="columns is-multiline">
            <div class="column is-12">
              <article class="message is-light">
                <div class="message-body">
                  Daily calorie goal:
                  <input type="number" class="input is-inline-block" style="max-width: 120px"
                         v-model.number="dailyCalorieGoal" @change="saveAll()">
                  kcal. Adjust your meals to stay within the desired range.
                </div>
              </article>
            </div>
            <div class="column is-12">
              <div class="table-container">
                <table class="table is-fullwidth is-striped is-narrow">
                  <thead>
                    <tr>
                      <th>Day</th>
                      <th>Breakfast</th>
                      <th>Lunch</th>
                      <th>Dinner</th>
                      <th>Calories (est.)</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(day, idx) in weekDays" :key="day">
                      <td class="nowrap"><strong>{{ day }}</strong></td>
                      <td>
                        <div v-if="planning[idx].breakfast">
                          <span class="icon-text">
                            <span class="icon"><i class="fa-solid fa-bread-slice"></i></span>
                            <span>{{ planning[idx].breakfast.title }}</span>
                          </span>
                        </div>
                        <div v-else class="has-text-grey">â€”</div>
                      </td>
                      <td>
                        <div v-if="planning[idx].lunch">
                          <span class="icon-text">
                            <span class="icon"><i class="fa-solid fa-bowl-food"></i></span>
                            <span>{{ planning[idx].lunch.title }}</span>
                          </span>
                        </div>
                        <div v-else class="has-text-grey">â€”</div>
                      </td>
                      <td>
                        <div v-if="planning[idx].dinner">
                          <span class="icon-text">
                            <span class="icon"><i class="fa-solid fa-drumstick-bite"></i></span>
                            <span>{{ planning[idx].dinner.title }}</span>
                          </span>
                        </div>
                        <div v-else class="has-text-grey">â€”</div>
                      </td>
                      <td class="has-text-dark">
                        <span :class="calorieClass(dayCalories(idx))">{{ dayCalories(idx) }} / {{ dailyCalorieGoal }} kcal</span>
                      </td>
                      <td class="has-text-right">
                        <div class="buttons are-small">
                          <div class="dropdown is-right" :class="{'is-active': openPlannerDropdown===idx}">
                            <div class="dropdown-trigger">
                              <button class="button is-light" @click="togglePlanner(idx)">
                                <span class="icon"><i class="fa-solid fa-plus"></i></span>
                                <span>Add</span>
                              </button>
                            </div>
                            <div class="dropdown-menu">
                              <div class="dropdown-content" style="max-height: 280px; overflow:auto;">
                                <div class="dropdown-item">
                                  <p class="small has-text-grey">Choose a recipe</p>
                                  <input class="input is-small mb-2" v-model="plannerSearch" placeholder="Filter..." />
                                </div>
                                <a class="dropdown-item"
                                   v-for="rec in recipesFilteredByPlanner"
                                   :key="rec.id"
                                   @click="assignToDay(idx, rec)">
                                  {{ rec.title }} <span class="tag is-light ml-2">{{ (rec.calories||'?') }} kcal</span>
                                </a>
                                <hr class="dropdown-divider">
                                <a class="dropdown-item" @click="openPlannerDropdown=null">Close</a>
                              </div>
                            </div>
                          </div>
                          <button class="button is-light" @click="clearDay(idx)">
                            <span class="icon"><i class="fa-regular fa-trash-can"></i></span>
                            <span>Clear</span>
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                  <tfoot>
                    <tr>
                      <th>Total week</th>
                      <th colspan="3"></th>
                      <th>{{ weekCalories }} kcal</th>
                      <th></th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- INVENTORY -->
        <div v-show="view==='inventory'">
          <div class="columns">
            <div class="column is-7">
              <p class="title is-5 has-text-dark">Ingredient Management</p>
              <div class="box">
                <div class="columns">
                  <div class="column">
                    <input class="input" v-model="newIngredient.name" placeholder="Name (e.g., Chicken)" />
                  </div>
                  <div class="column">
                    <input class="input" v-model="newIngredient.category" placeholder="Category (meat, vegetable...)" />
                  </div>
                </div>
                <div class="columns is-mobile">
                  <div class="column is-4">
                    <input class="input" type="number" min="0" v-model.number="newIngredient.kcal"
                           placeholder="kcal / 100g" />
                  </div>
                  <div class="column is-4">
                    <input class="input" v-model="newIngredient.unit" placeholder="Unit (g, ml, piece)" />
                  </div>
                  <div class="column is-4">
                    <button class="button is-danger is-fullwidth" @click="addIngredient()">Add</button>
                  </div>
                </div>
              </div>

              <div class="field has-addons">
                <div class="control is-expanded">
                  <input class="input" v-model="ingredientSearch" placeholder="Search for an ingredient..." />
                </div>
                <div class="control">
                  <div class="select">
                    <select v-model="ingredientFilter">
                      <option value="">All categories</option>
                      <option v-for="c in ingredientCategories" :key="c" :value="c">{{ c }}</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="table-container">
                <table class="table is-striped is-fullwidth is-narrow">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Category</th>
                      <th>kcal/100g</th>
                      <th>Unit</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="ing in filteredIngredients" :key="ing.id">
                      <td>{{ ing.name }}</td>
                      <td>{{ ing.category }}</td>
                      <td>{{ ing.kcal }}</td>
                      <td>{{ ing.unit }}</td>
                      <td class="has-text-right">
                        <button class="button is-small is-light" @click="editIngredient(ing)">
                          <span class="icon"><i class="fa-regular fa-pen-to-square"></i></span>
                        </button>
                        <button class="button is-small is-light" @click="deleteIngredient(ing)">
                          <span class="icon has-text-danger"><i class="fa-regular fa-trash-can"></i></span>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <article class="message is-info">
                <div class="message-body smaller">
                  Tip: you can link ingredients to a recipe when editing it to
                  estimate calories more accurately.
                </div>
              </article>
            </div>

            <div class="column is-5">
              <p class="title is-6 has-text-dark">Shopping Cart</p>
              <div class="box">
                <div class="field has-addons">
                  <div class="control is-expanded">
                    <input class="input" v-model="shoppingItem" placeholder="Add to cart..." />
                  </div>
                  <div class="control">
                    <button class="button is-light" @click="addToShopping()">
                      <span class="icon"><i class="fa-solid fa-cart-plus"></i></span>
                    </button>
                  </div>
                </div>

                <ul>
                  <li v-for="(it, idx) in shoppingList" :key="idx" class="mb-2">
                    <label class="checkbox">
                      <input type="checkbox" v-model="it.done" @change="saveAll()" />
                      <span :class="{'has-text-grey-light': it.done}" class="ml-2">{{ it.name }}</span>
                    </label>
                    <button class="button is-very-small is-white ml-2" title="Delete" @click="removeShopping(idx)">
                      <span class="icon has-text-danger"><i class="fa-regular fa-trash-can"></i></span>
                    </button>
                  </li>
                </ul>
                <button class="button is-light is-fullwidth mt-2" @click="shoppingList=[]; saveAll()">
                  Empty cart
                </button>
              </div>

              <p class="title is-6 has-text-dark">Health goals</p>
              <div class="box">
                <label class="label">Preferences</label>
                <div class="field">
                  <label class="checkbox">
                    <input type="checkbox" v-model="prefs.lowSalt" @change="saveAll()"> Low salt
                  </label>
                </div>
                <div class="field">
                  <label class="checkbox">
                    <input type="checkbox" v-model="prefs.lowSugar" @change="saveAll()"> Low sugar
                  </label>
                </div>
                <div class="field">
                  <label class="checkbox">
                    <input type="checkbox" v-model="prefs.highProtein" @change="saveAll()"> High protein
                  </label>
                </div>
              </div>

              <article class="message is-success">
                <div class="message-header">
                  <p>Halal and healthy</p>
                </div>
                <div class="message-body smaller">
                  All generated recipes are suggested as halal by default. However, always check your ingredients and labels.
                </div>
              </article>
            </div>
          </div>
        </div>

        <!-- TIPS -->
        <div v-show="view==='tips'">
          <div class="level">
            <div class="level-left">
              <div class="level-item">
                <p class="title is-5 has-text-dark">Chef's tips and best practices</p>
              </div>
            </div>
            <div class="level-right">
              <div class="level-item">
                <button class="button is-danger" :class="{'is-loading': tipLoading}" @click="generateChefTip()">
                  <span class="icon"><i class="fa-solid fa-graduation-cap"></i></span>
                  <span>New AI tip</span>
                </button>
              </div>
            </div>
          </div>

          <div class="columns is-multiline">
            <div class="column is-12" v-if="tips.length===0">
              <div class="notification is-light">Ask for a tip to get started.</div>
            </div>
            <div class="column is-12" v-for="(tip, idx) in tips" :key="idx">
              <article class="message is-info">
                <div class="message-header">
                  <p>Tip #{{ idx+1 }}</p>
                  <button class="delete" @click="removeTip(idx)"></button>
                </div>
                <div class="message-body">
                  <p class="mb-2">{{ tip.text }}</p>
                  <div class="tags">
                    <span class="tag is-light has-text-link" v-for="tg in tip.tags" :key="tg">{{ tg }}</span>
                  </div>
                </div>
              </article>
            </div>
          </div>
        </div>

        <!-- PROFILE -->
        <div v-show="view==='profile'">
          <div class="columns">
            <div class="column is-7">
              <div class="card">
                <header class="card-header">
                  <p class="card-header-title">Profile & progress</p>
                </header>
                <div class="card-content">
                  <div class="content">
                    <p><strong>Name:</strong> <input class="input is-inline-block" style="max-width: 260px"
                      v-model="profile.name" @change="saveAll()" placeholder="Your name" /></p>
                    <p><strong>Level:</strong> {{ level }}</p>
                    <p><strong>Total score:</strong> {{ totalScore }} pts</p>
                    <progress class="progress is-danger" :value="progressPercent" max="100">{{ progressPercent }}%</progress>

                    <div class="columns">
                      <div class="column">
                        <p class="heading">Recipes cooked</p>
                        <p class="title is-5">{{ stats.cooked }}</p>
                      </div>
                      <div class="column">
                        <p class="heading">Planning filled</p>
                        <p class="title is-5">{{ plannedMealsCount }}</p>
                      </div>
                      <div class="column">
                        <p class="heading">Challenges completed</p>
                        <p class="title is-5">{{ challengesDone }}</p>
                      </div>
                    </div>

                    <p class="small">Unlock badges by completing challenges and meeting your calorie goals.</p>
                    <div class="tags mt-2">
                      <span class="tag is-warning is-light" v-for="b in badges" :key="b">{{ b }}</span>
                    </div>
                  </div>
                </div>
                <footer class="card-footer">
                  <a class="card-footer-item" @click="exportData()">Export data</a>
                  <a class="card-footer-item" @click="importDialogOpen=true">Import</a>
                  <a class="card-footer-item is-danger" @click="clearAll()">Clear all data</a>
                </footer>
              </div>
            </div>

            <div class="column is-5">
              <div class="card is-hidden-mobile">
                <header class="card-header">
                  <p class="card-header-title">Shortcuts</p>
                </header>
                <div class="card-content">
                  <ul>
                    <li><span class="kbd">R</span> Generate an AI recipe</li>
                    <li><span class="kbd">T</span> Generate an AI tip</li>
                    <li><span class="kbd">D</span> Quick challenge</li>
                  </ul>
                </div>
              </div>

              <div class="card mt-4">
                <header class="card-header">
                  <p class="card-header-title">Settings</p>
                </header>
                <div class="card-content">
                  <button class="button is-link is-light" @click="installPwa()">
                    <span class="icon"><i class="fa-solid fa-download"></i></span>
                    <span>Install the application</span>
                  </button>
                  <p class="small has-text-grey mt-2">{{ pwaStatus }}</p>
                </div>
              </div>

              <div class="card mt-4">
                <header class="card-header">
                  <p class="card-header-title">About</p>
                </header>
                <div class="card-content">
                  <p class="small">
                    This serious game uses public AI services to generate text and images. The contents are suggestions and should be adapted to your nutritional needs and beliefs.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- FIXED FOOTER ACTIONS -->
    <div class="fixed-footer">
      <div class="container py-3">
        <div class="columns is-vcentered">
          <div class="column is-12-mobile is-8-tablet">
            <div class="field has-addons">
              <p class="control">
                <a class="button is-danger" @click="generateRecipe()" :class="{'is-loading': aiLoading}">
                  <span class="icon"><i class="fa-solid fa-wand-magic-sparkles"></i></span>
                  <span class="is-hidden-mobile">AI Recipe</span>
                </a>
              </p>
              <p class="control">
                <a class="button is-dark" @click="generateChefTip()" :class="{'is-loading': tipLoading}">
                  <span class="icon"><i class="fa-solid fa-graduation-cap"></i></span>
                  <span class="is-hidden-mobile">AI Tip</span>
                </a>
              </p>
              <p class="control">
                <a class="button" @click="quickChallenge()">
                  <span class="icon"><i class="fa-solid fa-bolt"></i></span>
                  <span class="is-hidden-mobile">Challenge</span>
                </a>
              </p>
              <p class="control is-expanded">
                <input class="input" v-model="aiPrompt" placeholder="AI Prompt (e.g., light couscous 500 kcal, halal)" />
              </p>
            </div>
          </div>
          <div class="column is-12-mobile is-4-tablet has-text-centered-mobile has-text-right-tablet">
            <span class="icon-text">
              <span class="icon has-text-danger"><i class="fa-solid fa-star"></i></span>
              <span>{{ totalScore }} pts</span>
            </span>
            <span class="tag is-danger is-light pill ml-2">Level {{ level }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- MODALS -->

    <!-- Edit Recipe Modal -->
    <div class="modal" :class="{'is-active': editRecipeModal}">
      <div class="modal-background" @click="editRecipeModal=false"></div>
      <div class="modal-card" style="width: 920px; max-width: 95vw;">
        <header class="modal-card-head">
          <p class="modal-card-title">Edit Recipe</p>
          <button class="delete" aria-label="close" @click="editRecipeModal=false"></button>
        </header>
        <section class="modal-card-body">
          <div v-if="editingRecipe">
            <div class="columns">
              <div class="column is-7">
                <div class="field">
                  <label class="label">Title</label>
                  <input class="input" v-model="editingRecipe.title" />
                </div>
                <div class="field">
                  <label class="label">Tags</label>
                  <input class="input" v-model="tagsBuffer" placeholder="Separated by commas (e.g., Main, Maghreb)" />
                </div>
                <div class="field">
                  <label class="label">Calories (estimated)</label>
                  <input class="input" type="number" v-model.number="editingRecipe.calories" />
                </div>
                <div class="field">
                  <label class="label">Steps (one per line)</label>
                  <textarea class="textarea" rows="6" v-model="stepsBuffer"></textarea>
                </div>
              </div>
              <div class="column is-5">
                <div class="field">
                  <label class="label">Ingredients (one per line)</label>
                  <textarea class="textarea" rows="6" v-model="ingredientsBuffer"></textarea>
                </div>
                <div class="field">
                  <label class="label">Image (auto-generated, can be regenerated)</label>
                  <figure class="image is-16by9 recipe-img" v-if="editingRecipe.imageUrl">
                    <img :src="editingRecipe.imageUrl" :alt="editingRecipe.title" />
                  </figure>
                  <button class="button is-light mt-2" @click="regenImageFor(editingRecipe)">
                    <span class="icon"><i class="fa-solid fa-image"></i></span>
                    <span>Regenerate image</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>
        <footer class="modal-card-foot">
          <button class="button is-danger" @click="saveEditingRecipe()">Save</button>
          <button class="button" @click="editRecipeModal=false">Close</button>
        </footer>
      </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" :class="{'is-active': importDialogOpen}">
      <div class="modal-background" @click="importDialogOpen=false"></div>
      <div class="modal-card" style="width: 760px; max-width: 95vw;">
        <header class="modal-card-head">
          <p class="modal-card-title">Import data</p>
          <button class="delete" aria-label="close" @click="importDialogOpen=false"></button>
        </header>
        <section class="modal-card-body">
          <p class="small">Paste the previously exported data here.</p>
          <textarea class="textarea" rows="10" v-model="importBuffer" placeholder='{"recipes":[...], ...}'></textarea>
        </section>
        <footer class="modal-card-foot">
          <button class="button is-danger" @click="performImport()">Import</button>
          <button class="button" @click="importDialogOpen=false">Cancel</button>
        </footer>
      </div>
    </div>

  </div>

  <script>
    // Utilities for Pollinations API
    // Text: we will use a simple GET request to the text endpoint if available,
    // otherwise fallback to a simpler prompt. Link taken from context: https://text.pollinations.ai/...
    // Images: https://image.pollinations.ai/prompt/<encoded prompt>
    const Pollinations = {
      imageUrl(prompt, width=1024, height=768, seed = -1, model='turbo'){
          return `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=${width}&height=${height}&seed=${seed}&model=${encodeURIComponent(model)}&nologo=true`;
        },
      // Text: we use a simple endpoint. If unavailable, we will fallback locally.
      textUrl(prompt) {
        // Simple public API (may change). We go through a text endpoint.
        // For better compatibility, we encode the prompt in the URL.
        return `https://text.pollinations.ai/${encodeURIComponent(prompt)}`;
      },
      async fetchText(prompt, timeoutMs = 20000) {
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), timeoutMs);
        try {
          const res = await fetch(this.textUrl(prompt), { signal: controller.signal });
          clearTimeout(t);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          // Some endpoints return raw text
          const txt = await res.text();
          return txt;
        } catch (e) {
          clearTimeout(t);
          // Fallback: generic message
          return null;
        }
      }
    };

    const app = Vue.createApp({
      data() {
        return {
          mobileNav: false,
          view: 'home',

          // AI
          aiPrompt: '',
          aiLoading: false,
          tipLoading: false,

          // Recipes
          recipes: [],
          searchRecipe: '',
          filterTag: '',
          editingRecipe: null,
          editRecipeModal: false,
          ingredientsBuffer: '',
          stepsBuffer: '',
          tagsBuffer: '',

          // Planning
          weekDays: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
          planning: Array.from({length: 7}, () => ({ breakfast: null, lunch: null, dinner: null })),
          dailyCalorieGoal: 1800,
          openPlannerDropdown: null,
          plannerSearch: '',

          // Ingredients
          ingredients: [],
          newIngredient: { name: '', category: '', kcal: 0, unit: '' },
          ingredientSearch: '',
          ingredientFilter: '',
          shoppingList: [],
          shoppingItem: '',

          // Tips
          tips: [],
          tipsRead: 0,

          // Challenges
          dailyChallenge: { title: 'Cook a seasonal dish', desc: 'Use at least 2 seasonal vegetables.', points: 20 },
          challengesDone: 0,

          // Profile & progress
          profile: { name: '' },
          totalScore: 0,
          stats: { cooked: 0 },
          badges: [],

          // Import/Export
          importDialogOpen: false,
          importBuffer: '',

          // PWA Install
          deferredPrompt: null,
          pwaStatus: ''
        }
      },
      computed: {
        filteredRecipes() {
          const q = this.searchRecipe.trim().toLowerCase();
          const tag = this.filterTag;
          return this.recipes.filter(r => {
            const matchesText = !q || (r.title.toLowerCase().includes(q) || r.ingredients.join(' ').toLowerCase().includes(q));
            const matchesTag = !tag || (r.tags || []).includes(tag);
            return matchesText && matchesTag;
          });
        },
        ingredientCategories() {
          const set = new Set(this.ingredients.map(i => i.category).filter(Boolean));
          return Array.from(set);
        },
        filteredIngredients() {
          const q = this.ingredientSearch.trim().toLowerCase();
          const f = this.ingredientFilter;
          return this.ingredients.filter(i => {
            const mt = !q || i.name.toLowerCase().includes(q);
            const mc = !f || i.category === f;
            return mt && mc;
          });
        },
        plannedMealsCount() {
          return this.planning.reduce((acc, d) => acc + ['breakfast','lunch','dinner'].filter(k => !!d[k]).length, 0);
        },
        weekCalories() {
          return this.planning.reduce((acc, _, i) => acc + this.dayCalories(i), 0);
        },
        progressPercent() {
          const needed = this.nextLevelTarget;
          if (needed === 0) return 100;
          const base = this.currentLevelFloor;
          const segment = needed - base;
          const val = Math.max(0, Math.min(100, Math.round(((this.totalScore - base) / segment) * 100)));
          return isNaN(val) ? 0 : val;
        },
        level() {
          // Simple progression curve: 0-99 pts L1, 100-249 L2, 250-449 L3, 450-699 L4, ...
          const s = this.totalScore;
          if (s < 100) return 1;
          if (s < 250) return 2;
          if (s < 450) return 3;
          if (s < 700) return 4;
          if (s < 1000) return 5;
          return Math.floor(5 + (s - 1000) / 400) + 1;
        },
        nextLevelTarget() {
          const s = this.totalScore;
          if (s < 100) return 100;
          if (s < 250) return 250;
          if (s < 450) return 450;
          if (s < 700) return 700;
          if (s < 1000) return 1000;
          const blocks = Math.floor((s - 1000) / 400) + 1;
          return 1000 + blocks * 400;
        },
        currentLevelFloor() {
          const s = this.totalScore;
          if (s < 100) return 0;
          if (s < 250) return 100;
          if (s < 450) return 250;
          if (s < 700) return 450;
          if (s < 1000) return 700;
          const blocks = Math.floor((s - 1000) / 400);
          return 1000 + blocks * 400;
        },
        recipesFilteredByPlanner() {
          const q = this.plannerSearch.trim().toLowerCase();
          return this.recipes.filter(r => !q || r.title.toLowerCase().includes(q));
        }
      },
      watch: {
        view(v) {
          // Navigation bonus
          if (v === 'planning') this.addScore(2);
          if (v === 'inventory') this.addScore(1);
        }
      },
      methods: {
        // STORAGE
        saveAll() {
          const data = {
            recipes: this.recipes,
            planning: this.planning,
            dailyCalorieGoal: this.dailyCalorieGoal,
            ingredients: this.ingredients,
            shoppingList: this.shoppingList,
            tips: this.tips,
            tipsRead: this.tipsRead,
            challengesDone: this.challengesDone,
            profile: this.profile,
            totalScore: this.totalScore,
            stats: this.stats,
            badges: this.badges
          };
          localStorage.setItem('mamachef:data', JSON.stringify(data));
        },
        loadAll() {
          const raw = localStorage.getItem('mamachef:data');
          if (!raw) return;
          try {
            const data = JSON.parse(raw);
            for (const k of Object.keys(data)) {
              this[k] = data[k];
            }
          } catch(e) {
            console.warn('Corrupted data, resetting.');
          }
        },
        exportData() {
          const data = localStorage.getItem('mamachef:data') || '';
          const blob = new Blob([data], {type: 'application/json'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'mamachef_data.json';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        },
        performImport() {
          try {
            const obj = JSON.parse(this.importBuffer);
            localStorage.setItem('mamachef:data', JSON.stringify(obj));
            this.loadAll();
            this.importDialogOpen = false;
            this.notify('Import successful.', 'is-success');
          } catch(e) {
            this.notify('Invalid import.', 'is-danger');
          }
        },
        clearAll() {
          if (!confirm('Clear all local data and start over?')) return;
          localStorage.removeItem('mamachef:data');
          location.reload();
        },

        // SIMPLE NOTIFY
        notify(msg, type='is-info', timeout=2000) {
          const n = document.createElement('div');
          n.className = `notification ${type}`;
          n.textContent = msg;
          n.style.position = 'fixed';
          n.style.right = '12px';
          n.style.bottom = '12px';
          n.style.zIndex = '9999';
          document.body.appendChild(n);
          setTimeout(() => n.remove(), timeout);
        },

        // SCORING
        addScore(points) {
          this.totalScore += points;
          this.saveAll();
          this.checkBadges();
        },
        checkBadges() {
          const push = (b) => { if (!this.badges.includes(b)) this.badges.push(b); };
          if (this.stats.cooked >= 1) push('First recipe');
          if (this.plannedMealsCount >= 7) push('Full week');
          if (this.tipsRead >= 3) push('Apprentice Chef');
          if (this.totalScore >= 250) push('Motivated');
          this.saveAll();
        },

        // RECIPES
        async generateRecipe() {
          try {
            this.aiLoading = true;
            const basePrompt = this.aiPrompt && this.aiPrompt.trim() ? this.aiPrompt.trim() :
              "Suggest a balanced halal recipe in English for a household, 500 to 700 kcal per serving, "
              +"with title, list of ingredients, clear steps (4 to 8), tags (Starter/Main/Dessert/Snack), "
              +"and calorie estimation. Concise style.";
            const promptText = `Generate a structured recipe in compact JSON format: { "title": "", "ingredients": ["..."], "steps": ["..."], "tags": ["Main"], "calories": 600 }.\nExclusively JSON.\nHalal and healthy constraint.\nRequest: ${basePrompt}`;
            const txt = await Pollinations.fetchText(promptText);
            let parsed = null;
            if (txt) {
              // Try to extract JSON if the AI returns additional text
              const match = txt.match(/\{[\s\S]*\}/);
              if (match) {
                try { parsed = JSON.parse(match[0]); } catch(e) { parsed = null; }
              }
            }
            if (!parsed) {
              // Local fallback
              parsed = {
                title: 'Grilled chicken salad with herbs',
                ingredients: ['Chicken', 'Green salad', 'Tomatoes', 'Cucumber', 'Lemon', 'Olive oil', 'Herbs', 'Salt'],
                steps: ['Grill the chicken', 'Cut the vegetables', 'Mix and season', 'Serve fresh'],
                tags: ['Main'],
                calories: 620
              };
            }
            const recipe = {
              id: 'r_' + Date.now(),
              title: parsed.title || 'Halal recipe',
              ingredients: Array.isArray(parsed.ingredients) ? parsed.ingredients : [],
              steps: Array.isArray(parsed.steps) ? parsed.steps : [],
              tags: Array.isArray(parsed.tags) ? parsed.tags : ['Main'],
              calories: typeof parsed.calories === 'number' ? parsed.calories : null,
              imageUrl: ''
            };
            // Generate image
            const imgPrompt = `Appetizing culinary photo, ${recipe.title}, chef presentation, halal, magazine style, natural lighting`;
            recipe.imageUrl = Pollinations.imageUrl(imgPrompt, 960, 540);

            this.recipes.unshift(recipe);
            this.addScore(10); // recipe creation
            this.saveAll();
            this.view = 'recipes';
            this.notify('Recipe generated!', 'is-success');
          } catch(e) {
            console.error(e);
            this.notify("Could not generate the recipe right now.", 'is-danger');
          } finally {
            this.aiLoading = false;
          }
        },
        editRecipe(r) {
          this.editingRecipe = JSON.parse(JSON.stringify(r));
          this.ingredientsBuffer = (this.editingRecipe.ingredients || []).join('\n');
          this.stepsBuffer = (this.editingRecipe.steps || []).join('\n');
          this.tagsBuffer = (this.editingRecipe.tags || []).join(', ');
          this.editRecipeModal = true;
        },
        saveEditingRecipe() {
          if (!this.editingRecipe) return;
          this.editingRecipe.ingredients = this.ingredientsBuffer.split('\n').map(s => s.trim()).filter(Boolean);
          this.editingRecipe.steps = this.stepsBuffer.split('\n').map(s => s.trim()).filter(Boolean);
          this.editingRecipe.tags = this.tagsBuffer.split(',').map(s => s.trim()).filter(Boolean);
          const idx = this.recipes.findIndex(r => r.id === this.editingRecipe.id);
          if (idx >= 0) {
            this.recipes[idx] = JSON.parse(JSON.stringify(this.editingRecipe));
          }
          this.editRecipeModal = false;
          this.editingRecipe = null;
          this.saveAll();
          this.notify('Recipe updated.', 'is-success');
        },
        deleteRecipe(r) {
          if (!confirm('Delete this recipe?')) return;
          this.recipes = this.recipes.filter(x => x.id !== r.id);
          this.saveAll();
        },
        async regenImageFor(r) {
          if (!r) return;
          const imgPrompt = `Appetizing culinary photo, ${r.title}, chef presentation, halal, magazine style, natural lighting`;
          r.imageUrl = Pollinations.imageUrl(imgPrompt, 960, 540, Math.floor(Math.random()*999999));
          if (this.editingRecipe && this.editingRecipe.id === r.id) {
            this.editingRecipe.imageUrl = r.imageUrl;
          }
          const idx = this.recipes.findIndex(x => x.id === r.id);
          if (idx>=0) this.recipes[idx].imageUrl = r.imageUrl;
          this.saveAll();
        },
        cookRecipe(r) {
          this.stats.cooked++;
          this.addScore(8);
          this.saveAll();
          this.notify('Well done! Recipe cooked. +8 pts', 'is-success');
        },

        // PLANNING
        togglePlanner(idx) {
          this.openPlannerDropdown = this.openPlannerDropdown === idx ? null : idx;
        },
        assignToDay(idx, rec) {
          // Smart choice: fill the next empty meal
          const slots = ['breakfast','lunch','dinner'];
          const day = this.planning[idx];
          const slot = slots.find(k => !day[k]) || 'lunch';
          this.planning[idx][slot] = { id: rec.id, title: rec.title, calories: rec.calories || 0 };
          this.openPlannerDropdown = null;
          this.addScore(3);
          this.saveAll();
        },
        clearDay(idx) {
          this.planning[idx] = { breakfast: null, lunch: null, dinner: null };
          this.saveAll();
        },
        dayCalories(idx) {
          const d = this.planning[idx];
          const sum = ['breakfast','lunch','dinner'].reduce((a,k)=>a+(d[k]?.calories || 0),0);
          return sum || 0;
        },
        calorieClass(val) {
          if (val === 0) return 'tag is-light';
          if (val <= this.dailyCalorieGoal + 100 && val >= this.dailyCalorieGoal - 200) return 'tag is-success is-light';
          if (val > this.dailyCalorieGoal + 200) return 'tag is-danger is-light';
          return 'tag is-warning is-light';
        },
        autoPlan() {
          if (this.recipes.length === 0) {
            this.notify('No recipes available.', 'is-warning');
            return;
          }
          const pick = () => this.recipes[Math.floor(Math.random()*this.recipes.length)];
          for (let i=0; i<7; i++) {
            this.planning[i] = {
              breakfast: { id: pick().id, title: pick().title, calories: pick().calories||0 },
              lunch: { id: pick().id, title: pick().title, calories: pick().calories||0 },
              dinner: { id: pick().id, title: pick().title, calories: pick().calories||0 }
            };
          }
          this.addScore(5);
          this.saveAll();
          this.notify('Auto-generated planning!', 'is-success');
        },
        addToPlan(r) {
          // Adds to the first free day/slot
          for (let i=0;i<7;i++) {
            const slots = ['breakfast','lunch','dinner'];
            const free = slots.find(k => !this.planning[i][k]);
            if (free) {
              this.planning[i][free] = { id: r.id, title: r.title, calories: r.calories||0 };
              this.addScore(2);
              this.saveAll();
              this.notify(`Added to ${this.weekDays[i]} (${free}).`, 'is-success');
              return;
            }
          }
          this.notify('No free slots. Open the planning to adjust.', 'is-warning');
        },

        // INGREDIENTS
        addIngredient() {
          const n = this.newIngredient;
          if (!n.name.trim()) return;
          this.ingredients.push({
            id: 'i_' + Date.now() + '_' + Math.floor(Math.random()*9999),
            name: n.name.trim(),
            category: n.category.trim() || 'Other',
            kcal: Number(n.kcal)||0,
            unit: n.unit.trim() || 'g'
          });
          this.newIngredient = { name: '', category: '', kcal: 0, unit: '' };
          this.addScore(1);
          this.saveAll();
        },
        editIngredient(ing) {
          const name = prompt('Name:', ing.name);
          if (name===null) return;
          const category = prompt('Category:', ing.category);
          if (category===null) return;
          const kcal = prompt('kcal/100g:', ing.kcal);
          if (kcal===null) return;
          const unit = prompt('Unit:', ing.unit);
          if (unit===null) return;
          ing.name = name.trim();
          ing.category = category.trim();
          ing.kcal = Number(kcal)||0;
          ing.unit = unit.trim();
          this.saveAll();
        },
        deleteIngredient(ing) {
          if (!confirm('Delete this ingredient?')) return;
          this.ingredients = this.ingredients.filter(x => x.id !== ing.id);
          this.saveAll();
        },
        addToShopping() {
          const s = this.shoppingItem.trim();
          if (!s) return;
          this.shoppingList.push({ name: s, done: false });
          this.shoppingItem = '';
          this.saveAll();
        },
        removeShopping(idx) {
          this.shoppingList.splice(idx,1);
          this.saveAll();
        },

        // TIPS
        async generateChefTip() {
          try {
            this.tipLoading = true;
            
            const prefText = [
              this.prefs.lowSalt ? 'low in salt' : null,
              this.prefs.lowSugar ? 'low in sugar' : null,
              this.prefs.highProtein ? 'high in protein' : null
            ].filter(Boolean).join(', ') || 'balanced';

            let prompt = `Give a new Chef's tip in English (${parseInt((1+Math.random())*2)}-${parseInt((1+Math.random())*3)} sentences) on ${prefText} cooking. Add 3 relevant tags. Response in JSON: {"text":"...", "tags":["...","...","..."]}.`;
            if (this.recipes.length){
                const randomRecipe = this.recipes[Math.floor(Math.random() * this.recipes.length)];
                prompt += ` Recipe: "${randomRecipe.title}". Ingredients [${randomRecipe.ingredients.join(', ')}].`;
            }
            const txt = await Pollinations.fetchText(prompt);
            let tip = null;
            if (txt) {
              const m = txt.match(/\{[\s\S]*\}/);
              if (m) {
                try { tip = JSON.parse(m[0]); } catch(e) {}
              }
            }
            if (!tip) {
              tip = { text: "Prepare your marinades in advance with mild spices and lemon to enhance halal meats. Limit salt and compensate with fresh herbs and citrus fruits.", tags: ['Halal','Marinade','Health'] };
            }
            this.tips.unshift(tip);
            this.tipsRead++;
            this.addScore(4);
            this.saveAll();
            this.notify('Tip added!', 'is-success');
          } catch(e) {
            console.error(e);
            this.notify("Could not get a tip right now.", 'is-danger');
          } finally {
            this.tipLoading = false;
          }
        },
        removeTip(idx) {
          this.tips.splice(idx,1);
          this.saveAll();
        },

        // CHALLENGES
        quickChallenge() {
          const challenges = [
            { title: '600 kcal menu', desc: 'Compose a lunch of around 600 kcal Â±100.', points: 15 },
            { title: 'Zero waste', desc: 'Cook by reusing a leftover from the fridge.', points: 12 },
            { title: 'Green & Protein', desc: 'Include 2 green vegetables and a source of protein.', points: 18 },
            { title: 'Hydration', desc: 'Serve 2 glasses of water with each meal of the day.', points: 8 },
            { title: 'Batch cooking', desc: 'Plan and prepare 2 meals in advance.', points: 20 },
          ];
          this.dailyChallenge = challenges[Math.floor(Math.random()*challenges.length)];
          this.view = 'home';
          this.notify('New challenge available!', 'is-info');
        },
        completeDailyChallenge() {
          this.addScore(this.dailyChallenge.points);
          this.challengesDone++;
          this.saveAll();
          this.notify(`Challenge validated! +${this.dailyChallenge.points} pts`, 'is-success');
        },

        // MISC
        handleHotkeys(e) {
          if (e.target && ['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
          if (e.key.toLowerCase() === 'r') this.generateRecipe();
          if (e.key.toLowerCase() === 't') this.generateChefTip();
          if (e.key.toLowerCase() === 'd') this.quickChallenge();
        },

        // PWA
        async installPwa() {
          if (this.deferredPrompt) {
            this.deferredPrompt.prompt();
            const { outcome } = await this.deferredPrompt.userChoice;
            if (outcome === 'accepted') {
              this.pwaStatus = 'Installation accepted. The application will be installed.';
              this.notify('Application installed!', 'is-success');
            } else {
              this.pwaStatus = 'Installation canceled.';
            }
            this.deferredPrompt = null;
          } else if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
            this.pwaStatus = 'The application is already installed.';
            this.notify(this.pwaStatus, 'is-info');
          }
          else {
            this.pwaStatus = 'The browser does not support installation or the event has not yet been received. Try again in a few moments.';
            this.notify('The application is not installable at the moment.', 'is-warning');
          }
        }
      },
      created() {
        // PWA Install Prompt
        if ('serviceWorker' in navigator) {
          window.addEventListener('beforeinstallprompt', (e) => {
            // e.preventDefault(); // Do not prevent the native prompt, but keep a reference
            this.deferredPrompt = e;
            this.pwaStatus = 'Ready for offline installation. If you decline, you can do it later via the button.';
          });

          if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
            this.pwaStatus = 'The application is launched in standalone mode (installed).';
          } else {
            this.pwaStatus = 'The application can be installed for offline access.';
          }
        } else {
          this.pwaStatus = 'Service Worker not supported, offline installation is impossible.';
        }

        // Health prefs
        this.prefs = { lowSalt: false, lowSugar: false, highProtein: false };

        // Load data
        this.loadAll();

        // Init default values if empty
        if (!this.recipes.length) {
          // A starter recipe
          const starter = {
            id: 'r_seed',
            title: 'Light vegetable couscous',
            ingredients: ['Semolina', 'Carrots', 'Zucchini', 'Chickpeas', 'Tomatoes', 'Onions', 'Spices (ras el hanout)', 'Olive oil', 'Salt'],
            steps: ['Steam the semolina','Prepare the spicy broth','Cook the vegetables','Assemble and serve'],
            tags: ['Main','Maghreb'],
            calories: 650,
            imageUrl: Pollinations.imageUrl('Photo couscous with vegetables, halal, healthy, magazine style, natural lighting', 960, 540)
          };
          this.recipes.push(starter);
        }

        window.addEventListener('keydown', this.handleHotkeys);
      },
      beforeUnmount() {
        window.removeEventListener('keydown', this.handleHotkeys);
      }
    });

    app.mount('#app');

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, err => {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
  </script>
</body>
</html>